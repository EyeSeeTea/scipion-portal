{% extends 'showj/showj_base.html' %}
{% load staticfiles %}
{% block head %}
	<!-- Overwrite general section property for volume view with Chimera -->
	<style type="text/css">
		section {
		  display: -webkit-box;
		  -webkit-box-orient: horizontal;
		  -webkit-box-pack: center;
		  -webkit-box-align: center;
		 
		  display: -moz-box;
		  -moz-box-orient: horizontal;
		  -moz-box-pack: center;
		  -moz-box-align: center;

		  display: box;
		  box-orient: horizontal;
		  box-pack: center;
		  box-align: center;
			padding: 0px;
			width:100%;
		}

		#thresholdParams {
			padding: 20px;

		}
		#slider {  
	 		position:absolute; 
			width: 9em;
			margin: 5px 0 5px 0;
		}
		
	</style>
	<script src="{{jquery_ui}}"></script>
	<!--<script src="{{ngl}}"></script>-->
	<link rel="stylesheet" href="{{jquery_ui_css}}">
	<link rel="stylesheet" href="{{messi_css}}">
  	<script type="text/javascript">
  	
  	function putWait(){
		new Messi("<i class='fa fa-picture-o'/>  Loading Volume...",{
			modal : true
		});
		/* console.log("putWait") */
  	}
  	
  	function removeWait(){
  		$('.messi').remove();
		$('.messi-modal').remove();
		/* console.log("removeWait") */
  	}
	
  	function updateThreshold(){
  		putWait();
  		
		var threshold = $("input#thresholdValue").val();
		if (threshold == undefined){
			threshold = $("input#thresholdValue").attr("value");
		}

		surfaceComponent.clearRepresentations();
		surfaceComponent.addRepresentation("surface", {isolevel: threshold});

		removeWait();

	};

	function addSlider(){
		// Slider invoke and events
  		$("span#slider").slider({
  			animate : true,
  			range: "min",
  			value: {{threshold}},
  			min: {{minStats}},
  			max: {{maxStats}},
  			step: 0.01,
  			slide: function(event, ui) {
  				$("#thresholdValue").val(ui.value);
  			},
  			change: function(event, ui) {
  				updateThreshold();
  			}
  		});
	};

  	$(document).ready(function(){

  		// Event changing the volume
  		$("select#id_volumesToRenderComboBox").change(function(){
  			putWait();
  		})

  		// Press Ctrl event when change threshold
		document.getElementById('thresholdValue').addEventListener('keypress', function(event) {
	        if (event.keyCode == 13) {
	        	updateThreshold();
	        }
    	});

		addSlider();

		if( !Detector.webgl ) Detector.addGetWebGLMessage();

		NGL.mainScriptFilePath = "{{ngl}}";

		function onInit(){
			stage = new NGL.Stage( "viewport" );
			stage.setTheme("light");
//			stage.loadFile( "rcsb://1crn", { defaultRepresentation: true } );

			var fileURL =  getSubDomainURL() + '/get_file/?path={{volPath}}&filename=ngloutput.mrc'

			stage.loadFile( fileURL ).then( function( o ){


				surfaceComponent = o;
            	o.addRepresentation( "surface", { isolevel: {{threshold}} });
            	o.centerView();

	        } );
		};

		NGL.init( onInit );


  	});

	var stage;
	var surfaceComponent;
	</script>
{% endblock %}
{% block content_menu %}{% endblock %}
{% block content_view %}
	<div id="params">
		{% autoescape off %}
		<div id="viewport" style="width:1024px; height:420px;"></div>
		{% endautoescape %}

		<div id="thresholdParams">
			Threshold
			<input id="thresholdValue" type="text" value="{{threshold}}" style="width:11.2em;text-align:center;"/>
			<input id="thresholdButton" class="btn button2 primary_inv" type="button" value="Refresh" onclick="updateThreshold();"/>
			<br />
			Min [{{minStats}}], Max [{{maxStats}}]
			<br />
			<span id="slider"></span>
		</div>
		
	</div>
	
{% endblock %}

{% block content_end_page %}
<div id="fallback" class="fallback"></div>

{% endblock %}

{% block bottom_menu %}
	<!-- VOLUME MENU -->
	{% include "showj/showj_bottom_vol_menu.html" %}
{% endblock %}

